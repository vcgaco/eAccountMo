@model eAccount.Models.ViewModel.FinancialPerformanceViewModel

@{
    ViewData["Title"] = "Statement of Financial Performance";
}

<h3 class="mb-3">Statement of Financial Performance</h3>

<form method="get" class="mb-4">
    <div class="row g-2 align-items-end">

        <div class="col-md-3">
            <label>Fund</label>
            <select id="fundId" name="fundId" class="form-select">
                <option value="">-- Select Fund --</option>
                @foreach (var f in ViewBag.Funds)
                {
                    <option value="@f.Value"
                            selected="@(f.Value == (ViewBag.SelectedFund?.ToString() ?? "") ? "selected" : null)">
                        @f.Text
                    </option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label>Special Account</label>
            <select id="specialAccountId" name="specialAccountId" class="form-select">
                <option value="">-- All --</option>
                @foreach (var s in ViewBag.SpecialAccounts)
                {
                    <option value="@s.Value"
                            selected="@(s.Value == (ViewBag.SelectedSpecial?.ToString() ?? "") ? "selected" : null)">
                        @s.Text
                    </option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label>As of Month</label>
            <input type="month" name="period" class="form-control"
                   value="@ViewBag.Period" />
        </div>

        <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">
                Filter
            </button>
        </div>

    </div>
</form>

@if (Model == null || (Model.Revenues.Count == 0 && Model.Expenses.Count == 0))
{
    <div class="alert alert-info">
        Please select filter to generate report.
    </div>
}
else
{
    <table class="table table-bordered">

        <!-- ✅✅✅ REVENUE SECTION -->
        <thead class="table-dark">
            <tr>
                <th colspan="3">REVENUE</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var r in Model.Revenues)
            {
                <tr>
                    <td style="width:20%">@r.AccountCode</td>
                    <td>@r.AccountName</td>
                    <td class="text-end">
                        @(r.Amount < 0
                                        ? $"({Math.Abs(r.Amount).ToString("N2")})"
                                        : r.Amount.ToString("N2"))
            </td>
        </tr>
                }

            <tr class="table-secondary fw-bold">
                <td colspan="2" class="text-end">TOTAL REVENUE</td>
                <td class="text-end">
                    @Model.TotalRevenue.ToString("N2")
                </td>
            </tr>

            <!-- ✅✅✅ EXPENSE SECTION -->
        <thead class="table-dark">
            <tr>
                <th colspan="3">EXPENSES</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var e in Model.Expenses)
            {
                <tr>
                    <td style="width:20%">@e.AccountCode</td>
                    <td>@e.AccountName</td>
                    <td class="text-end">
                        @(e.Amount < 0
                                        ? $"({Math.Abs(e.Amount).ToString("N2")})"
                                        : e.Amount.ToString("N2"))
            </td>
        </tr>
                }

        <tr class="table-secondary fw-bold">
            <td colspan="2" class="text-end">TOTAL EXPENSES</td>
            <td class="text-end">
                @Model.TotalExpenses.ToString("N2")
            </td>
        </tr>

        <!-- ✅✅✅ NET SURPLUS / DEFICIT -->
        <tr class="table-success fw-bold">
            <td colspan="2" class="text-end">NET SURPLUS / (DEFICIT)</td>
            <td class="text-end">
                @(Model.NetSurplus < 0
                                ? $"({Math.Abs(Model.NetSurplus).ToString("N2")})"
                                : Model.NetSurplus.ToString("N2"))
            </td>
        </tr>

        </tbody>
    </table>
}

@section Scripts {
    <script>
        document.getElementById("fundId").addEventListener("change", function () {

            const fundId = this.value;
            const special = document.getElementById("specialAccountId");

            special.innerHTML = '<option value="">-- All --</option>';

            if (!fundId) return;

            fetch('/FinancialPerformance/GetSpecialAccountsByFund?fundId=' + fundId)
                .then(res => res.json())
                .then(data => {
                    data.forEach(x => {
                        let opt = document.createElement("option");
                        opt.value = x.id;
                        opt.text = x.accountName;
                        special.appendChild(opt);
                    });
                });
        });
    </script>
}
