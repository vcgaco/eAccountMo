@model List<eAccount.Models.ViewModel.SubsidiaryMonitoringVM>

@{
    ViewData["Title"] = "Subsidiary Account Monitoring";
}

<h3><i class="fa fa-bar-chart" aria-hidden="true"></i>Subsidiary Account Monitoring</h3>

<!-- Include Select2 CSS/JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<form method="get" class="row g-2 mb-3" id="subsidiaryForm">

    <!-- ✅ ACCOUNT (ONLY WITH SUBSIDIARY) -->
    <div class="col-md-4">
        <label>Account</label>
        <select name="accountId" class="form-control" id="accountSelect" required>
            <option value="">-- Select Account --</option>
            @foreach (var acc in ViewBag.Accounts)
            {
                <option value="@acc.Id"
                        selected="@(ViewBag.SelectedAccount?.ToString() == acc.Id.ToString())">
                    @acc.AccountCode - @acc.AccountName
                </option>
            }
        </select>
    </div>

    <!-- ✅ SUBSIDIARY -->
    <div class="col-md-4">
        <label>Subsidiary</label>
        <select name="subsidiaryId" class="form-control" id="subsidiarySelect" required>
            <option value="">-- Select Subsidiary --</option>
            @if (ViewBag.Subsidiaries != null)
            {
                foreach (var s in ViewBag.Subsidiaries)
                {
                    <option value="@s.Id"
                            selected="@(ViewBag.SelectedSubsidiary?.ToString() == s.Id.ToString())">
                        @s.SubsidiaryCode - @s.SubsidiaryName
                    </option>
                }
            }
        </select>
    </div>

    <!-- ✅ AS OF DATE -->
    <div class="col-md-3">
        <label>As of Date</label>
        <input type="date" name="asOfDate"
               value="@ViewBag.AsOfDate"
               class="form-control" />
    </div>

    <div class="col-md-2 align-self-end">
        <button class="btn btn-primary">View</button>
    </div>
</form>

@if (Model != null && Model.Any())
{
    <table class="table table-bordered table-striped">
        <thead class="table-light">
            <tr>
                <th>Date</th>
                <th>JEV</th>
                <th>Particular</th>
                <th class="text-end">Debit</th>
                <th class="text-end">Credit</th>
                <th class="text-end">Balance</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var row in Model)
            {
                <tr>
                    <td>@row.Date.ToShortDateString()</td>
                    <td>@row.JevNo</td>
                    <td>@row.Particular</td>
                    <td class="text-end">
                        @(row.Debit != 0 ? row.Debit.ToString("N2") : "")
                    </td>
                    <td class="text-end">
                        @(row.Credit != 0 ? row.Credit.ToString("N2") : "")
                    </td>
                    <td class="text-end">@row.Balance.ToString("N2")</td>
                </tr>
            }
        </tbody>
        <tfoot class="table-light">
            <tr>
                <th colspan="3" class="text-end">TOTAL</th>
                <th class="text-end">@Model.Sum(x => x.Debit).ToString("N2")</th>
                <th class="text-end">@Model.Sum(x => x.Credit).ToString("N2")</th>
                <th></th>
            </tr>
        </tfoot>
    </table>
}
else
{
    <div class="alert alert-info">
        Select an account and subsidiary to view transactions.
    </div>
}

<script>
    $(document).ready(function () {
        // Initialize Select2 for searchability
        $('#accountSelect, #subsidiarySelect').select2({
            width: '100%'
        });

        // Auto-load subsidiaries when account changes
        $('#accountSelect').on('change', function () {
            var accountId = $(this).val();
            if (!accountId) {
                $('#subsidiarySelect').html('<option value="">-- Select Subsidiary --</option>').trigger('change');
                return;
            }

            $.ajax({
                url: '@Url.Action("GetSubsidiariesByAccount", "SubsidiaryMonitoring")',
                type: 'GET',
                data: { accountId: accountId },
                success: function (subs) {
                    var html = '<option value="">-- Select Subsidiary --</option>';
                    subs.forEach(function (s) {
                        html += `<option value="${s.id}">${s.subsidiaryCode} - ${s.subsidiaryName}</option>`;
                    });
                    $('#subsidiarySelect').html(html).trigger('change');
                },
                error: function () {
                    console.error("Failed to load subsidiaries.");
                }
            });
        });
    });
</script>
